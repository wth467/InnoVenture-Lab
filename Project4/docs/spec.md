# SM3 数学描述与实现说明

本文档给出 SM3 哈希算法的数学定义、消息填充、消息扩展与压缩函数逐步推导，供实现与验证使用。

## 1. 算法概览
SM3 是国产标准的一种 256-bit 输出的密码学哈希函数，采用 Merkle–Damgård 迭代结构。协议流程包括：
1. 消息填充（使消息位长为 512 的整数倍）
2. 按 512-bit 分组对每一块执行消息扩展与压缩函数
3. 产生最终 256-bit 摘要

## 2. 参数
- 输出长度：256 bits（8 个 32-bit 词）
- 分组长度：512 bits（16 个 32-bit 词）
- 轮数：64
- 常量：
  - T_j = 0x79CC4519, j=0..15
  - T_j = 0x7A879D8A, j=16..63

## 3. 初始化向量 (IV)
按规范给定 8 个 32-bit 初始值：
IV = (0x7380166F, 0x4914B2B9, 0x172442D7, 0xDA8A0600,
0xA96F30BC, 0x163138AA, 0xE38DEE4D, 0xB0FB0E4E)

## 4. 填充规则
给定原消息 m，位长为 l：
- 追加 '1' bit（字节层面为 0x80）
- 追加若干 '0' bit，直到 (l + 1 + k) ≡ 448 (mod 512)
- 追加 64-bit 大端整数表示的原始消息长度 l
这和 SHA 系列填充方法思路相同。

## 5. 消息扩展（Message Expansion）
将 512-bit 块分成 16 个 32-bit 词 W0..W15（大端）。
为 j = 16..67 递推：
W_j = P1(W_{j-16} ⊕ W_{j-9} ⊕ (W_{j-3} <<< 15))⊕ (W_{j-13} <<< 7) ⊕ W_{j-6}
并定义：
W'j = W_j ⊕ W{j+4}  (j = 0..63)

此处 P1(X) = X ⊕ (X <<< 15) ⊕ (X <<< 23)。

## 6. 压缩函数（Compression Function）
令链值为 (A,B,C,D,E,F,G,H)。对 j=0..63：
SS1 = ((A <<< 12) + E + (T_j <<< j)) <<< 7
SS2 = SS1 ⊕ (A <<< 12)
TT1 = FF_j(A,B,C) + D + SS2 + W'_j
TT2 = GG_j(E,F,G) + H + SS1 + W_j
D = C
C = B <<< 9
B = A
A = TT1
H = G
G = F <<< 19
F = E
E = P0(TT2)
循环结束后：
V_{i+1} = V_i ⊕ (A,B,C,D,E,F,G,H)

## 7.  最终输出
对所有消息块执行压缩、更新链值后，取最终链值 V_n（8 * 32-bit）并以大端拼接为 32 字节，即为 SM3(m)。

